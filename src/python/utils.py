
"""
Functions that are useful in various places, but have no common theme.
"""

import logging
logging.basicConfig()
logger = logging.getLogger(__name__)

import cPickle
import os
import signal
import struct
import sys
import time
import __builtin__

from pprint import pprint
from argparse import ArgumentParser
from multiprocessing import Process, Pipe
from itertools import izip

import numpy as np

try:
    import matplotlib.pyplot as plt
    import matplotlib.cm as cm
except:
    logger.warning('could not load matplotlib -- plotting disabled')


class odinparser(ArgumentParser):
    """
    Simple extension of argparse, designed to automatically print stuff
    """
    def parse_args(self):
        print graphic
        args = super(odinparser, self).parse_args()
        pprint(args.__dict__)
        return args


def spawn(f):
    """
    Helper function for parmap()
    """
    def fun(pipe,x):
        pipe.send(f(x))
        pipe.close()
    return fun
        

def parmap(f,X):
    """
    Equivalent to multiprocessing.map(), but can be called from within a class.
    """
    pipe=[Pipe() for x in X]
    proc=[Process(target=spawn(f),args=(c,x)) for x,(p,c) in izip(X,pipe)]
    [p.start() for p in proc]
    [p.join() for p in proc]
    return [p.recv() for (p,c) in pipe]        
        

def write_sample_input(filename='sample.odin'):
    txt=''' # THIS FILE WAS GENERATED BY ODIN -- sample input file
    
    runname: testrun                 # used to name directories, etc.
    
    
    # RUN SETTINGS 
    predict:   boltzmann             # {single, boltzmann, kinetic} ensembles
    sampling:  md                    # either {md, mc} for dynamics, Monte Carlo
    prior:     minimal               # could be amber99sb-ildn, charm22, etc.
    solvent:   none                  # grand cannonical solvent to employ
    outputdir: ~/testrun             # where stuff gets written -- could be GB.
    
    
    # EXPERIMENTS
    experiment: LCLS_run_1           # a name identifying the data
        - dir:  ~/testrun/lcls       # should contain pre-processed data files
        - type: scattering           # {scattering, chemshift} are in now
    
    experiment: NMR_HSQC_1
        - dir:  ~/testrun/chemshifts
        - type: chemshift
        
        
    # RESOURCES
    runmode: cluster                 # one of {local, cluster}
    nodes:   4                       # how many nodes to call for
    gpn:     1                       # gpus per node
    REMD:    True                    # use REMD to estimate the lambdas
    temps:   [1, 0.5, 0.1, 0.01]     # temps in units of beta, <= nodes*gpn
    
    '''
    f = open(filename, 'w')
    f.write(txt)
    f.close()
    logger.info("Wrote: %s" % filename)
    return
    

def plot_polar_intensities(shot, output_file=None):
    """
    Plot an intensity map in polar coordinates.
    
    Parameters
    ----------
    shot : odin.xray.Shot
        A shot to plot.
    output_file : str
        The filename to write. If `None`, will display the image on screen and
        not save.
    """

    pi = shot.polar_grid

    colors = shot.polar_intensities # color by intensity
    ax = plt.subplot(111, polar=True)
    c = plt.scatter(pi[:,1], pi[:,0], c=colors, cmap=cm.hsv)
    c.set_alpha(0.75)

    if output_file:
        plt.savefig(output_file)
        logger.info("Saved: %s" % output_file)
    else:
        plt.show()

    return


graphic = """
	                                    .  
	                                  .#   
	           .                     .##   
	          #.                     #  :  
	       .# .                     .# .#  
	       .. .       ..##.         #   #  
	       #  .     .#.    #       #    #  
	             .#         #.    #    #   
	      #    #             #.  #.    #   
	      # .#                ##      #    
	      ##.                #.      :#       ____  _____ _____ _   _ 
	      #                 .# .:   .#       / __ \|  __ \_   _| \ | |
	   .:.      .    .      .#..   .#       | |  | | |  | || | |  \| |
	  .####  . . ...####     #.   #.        | |  | | |  | || | | . ` |
	 # .##   . # . #.#   . =# .##.#         | |__| | |__| || |_| |\  |
	 . .##   .  #   ..   # = .=#  #          \____/|_____/_____|_| \_|
	#   . ####     .###,  ,      ##        
	#.## .               '#.. #    #                       Observation
	 .                      ##.. . #       	               Driven
	                          .#   #                       Inference
	                            #. /                   of eNsembles
		                        .#        

     ----------------------------------------------------------------------
"""
